<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>badmoodgame - FINAL DEBUG</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === MINIMALES CSS ZUM DEBUGGEN === */
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            margin: 0; padding: 20px; /* Padding zum Sehen */
        }
        #login-modal {
            position: fixed; top: 10%; left: 10%; width: 80%; /* Zentriert grob */
            background-color: #333; /* Sichtbarer Hintergrund */
            z-index: 1000;
            display: none; /* Startet versteckt, JS muss es anzeigen */
            padding: 20px;
            border: 2px solid red;
        }
        .login-box { /* Nur minimales Styling */
             border: 1px solid yellow; padding: 10px;
        }
        #main-content {
            display: none; /* Startet versteckt */
            border: 2px solid lightblue;
            padding: 20px;
        }
        /* Verstecke alle Sektionen im Main Content standardmäßig */
        #main-content section {
            /* display: none; */ /* Oder lasse sie sichtbar zum Testen */
             margin-bottom: 10px; border: 1px dashed gray; padding: 10px;
        }
        .user-profile {
             display: none; /* JS steuert */
             border-bottom: 1px solid white; padding-bottom: 10px; margin-bottom: 10px; color: white;
        }
        #logout-button { display: none; } /* JS steuert */

        /* Minimales Styling für Formularelemente im Modal */
         .login-box h2 { color: white; margin-bottom: 15px;}
         .login-box label { display: block; color: #ccc; margin-bottom: 3px;}
         .login-box input { display: block; width: 90%; margin-bottom: 10px; padding: 5px; background: #444; color: white; border: 1px solid #666;}
         .login-box button { padding: 8px 15px; margin-top: 10px; cursor: pointer;}
         #auth-message { min-height: 1.2em; margin-top: 10px; color: red;} #auth-message.success{color:lightgreen;}
         .auth-switch, .forgot-password-link { margin-top: 15px; font-size: 0.9em;}
         .auth-switch a, .forgot-password-link a { color: lightblue; cursor: pointer; }

        /* --- ALLES ANDERE CSS AUSKOMMENTIERT --- */
        /*
        .container { ... } header { ... } nav { ... }
        .login-box { ... komplexeres ... } .user-profile { ... komplexeres ... }
        section { ... komplexeres ... } footer { ... } ... etc ...
        */
    </style>
</head>
<body>

    <!-- Login Modal (Muss gefunden werden!) -->
    <div id="login-modal">
        <div class="login-box">
             <p style="color: #ccc;">Lade UI...</p>
        </div>
    </div>

    <!-- Hauptinhalt (Muss gefunden werden!) -->
    <div id="main-content">
        <header><h1>BADMOODGAME</h1></header>
        <nav>(Nav)</nav>
        <div class="container">
            <div class="user-profile"> <!-- Muss gefunden werden! -->
                <span class="username" id="user-username">Spieler</span>
                <button id="logout-button">Logout</button> <!-- Muss gefunden werden! -->
            </div>
             <section id="problems"><h2>Probleme</h2><p>...</p></section>
             <section id="solutions"><h2>Lösungen</h2><p>...</p></section>
             <section id="quiz"><h2>Quiz</h2><p>...</p></section>
        </div>
        <footer>(Footer)</footer>
    </div>

    <script>
        console.log("SCRIPT START vFinalDebug");

        // --- SUPABASE INITIALISIERUNG ---
        const SUPABASE_URL = "https://baifviqcjqmdtmjlseun.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJhaWZ2aXFjanFtZHRtamxzZXVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYyOTE4MTksImV4cCI6MjA2MTg2NzgxOX0.-zoFCE57MZcTynDVQlsT5K4viVRf0HBtjctNoBH64GA";
        let supabase = null;
        let initError = null;

        try {
            if (window.supabase?.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase Client OK.');
            } else { throw new Error('Supabase Library fehlt.'); }
        } catch (error) { console.error('FATAL: Supabase Init Fehler:', error); initError = error; }

        // --- DOM ELEMENT REFERENZEN ---
        let loginModal, loginBox, mainContent, userProfileDiv, usernameDisplay, logoutButton;

        // --- AUTH ---
        let currentUser = null;
        let userEmailForConfirmation = null;

        // --- FUNKTIONEN ---

        function assignCoreDomElements() {
            console.log("assignCoreDomElements: Suche...");
            loginModal = document.getElementById('login-modal');
            loginBox = loginModal ? loginModal.querySelector('.login-box') : null;
            mainContent = document.getElementById('main-content');
            userProfileDiv = mainContent ? mainContent.querySelector('.user-profile') : null;
            usernameDisplay = document.getElementById('user-username');
            logoutButton = document.getElementById('logout-button');
            console.log(`  loginModal gefunden: ${!!loginModal}`);
            console.log(`  loginBox gefunden: ${!!loginBox}`);
            console.log(`  mainContent gefunden: ${!!mainContent}`);
            console.log(`  userProfileDiv gefunden: ${!!userProfileDiv}`);
            console.log(`  usernameDisplay gefunden: ${!!usernameDisplay}`);
            console.log(`  logoutButton gefunden: ${!!logoutButton}`);
            if (!loginModal || !mainContent || !loginBox || !logoutButton || !usernameDisplay || !userProfileDiv) {
                 console.error("FEHLER: Kritische UI-Elemente fehlen!");
                 return false;
             }
             console.log("assignCoreDomElements: Kern-Elemente OK.");
             return true;
        }

        function showUIElement(element) {
             if (!element) { console.warn("Versuch, undefiniertes Element anzuzeigen."); return; }
             const displayStyle = (element.id === 'login-modal' || element.classList.contains('user-profile')) ? 'flex' : 'block';
             console.log(`  -> Zeige #${element.id} (display=${displayStyle})`);
             try { element.style.display = displayStyle; }
             catch (e) { console.error(`Fehler beim Anzeigen von #${element?.id}:`, e); }
        }
        function hideUIElement(element) {
            if (!element) { console.warn("Versuch, undefiniertes Element zu verstecken."); return; }
            console.log(`  -> Verstecke #${element.id}`);
             try { element.style.display = 'none'; }
             catch (e) { console.error(`Fehler beim Verstecken von #${element?.id}:`, e); }
        }
        function updateLoginBox(htmlContent) {
             if (!loginBox) { console.error("LoginBox nicht verfügbar."); return false; }
             try { loginBox.innerHTML = htmlContent; return true; }
             catch(e) { console.error("Fehler loginBox.innerHTML:", e); return false; }
         }

        // UI Update Funktionen (minimal)
        function showLoginForm(message = '', messageClass = '') {
            console.log("UI ACTION: showLoginForm");
            const html = `<h2>Login</h2><form id="actual-login-form"><label>E-Mail:</label><input type="email" id="login-email" required><label>Passwort:</label><input type="password" id="login-password" required><div id="auth-message" class="${messageClass}">${message}</div><button type="submit">Login</button></form><a data-action="forgot-password">PW vergessen?</a> | <a data-action="show-register">Registrieren</a>`;
            if (updateLoginBox(html)) showUIElement(loginModal);
        }
        function showRegisterForm(message = '', messageClass = '') {
            console.log("UI ACTION: showRegisterForm");
            const html = `<h2>Registrieren</h2><form id="actual-register-form"><label>E-Mail:</label><input type="email" id="register-email" required><label>Passwort:</label><input type="password" id="register-password" required minlength="6"><label>Name:</label><input type="text" id="register-username" required><div id="auth-message" class="${messageClass}">${message}</div><button type="submit">Registrieren</button></form><a data-action="show-login">Login</a>`;
            if (updateLoginBox(html)) showUIElement(loginModal);
        }
         function showForgotPasswordForm() {
             console.log("UI ACTION: showForgotPasswordForm");
             const html = `<h2>PW Reset</h2><form id="forgot-password-form"><label>E-Mail:</label><input type="email" id="forgot-email" required><div id="auth-message"></div><button type="submit">Link senden</button></form><a data-action="show-login">Login</a>`;
             if (updateLoginBox(html)) showUIElement(loginModal);
         }
         function showUpdatePasswordForm() {
             console.log("UI ACTION: showUpdatePasswordForm");
             const html = `<h2>Neues PW</h2><form id="update-password-form"><label>Neues Passwort:</label><input type="password" id="update-password" required minlength="6"><div id="auth-message"></div><button type="submit">Speichern</button></form><a data-action="show-login">Login</a>`;
             if (updateLoginBox(html)) showUIElement(loginModal);
         }
         function showConfirmationMessage(email) {
             console.log("UI ACTION: showConfirmationMessage für:", email);
             userEmailForConfirmation = email;
             const html = `<h2>Bestätigung</h2><p>Mail an <strong>${email}</strong> gesendet.</p><div id="auth-message"></div><button data-action="resend-confirmation">Erneut senden</button> | <a data-action="logout">Logout</a>`;
             if (updateLoginBox(html)) {
                 console.log("Versuche Modal anzuzeigen für Confirmation...");
                 showUIElement(loginModal);
                 console.log(`Modal display nach showUIElement: ${loginModal ? loginModal.style.display : 'FEHLER'}`);
             } else { console.error("Konnte Confirmation Message Box nicht updaten.");}
         }

        // Handler Funktionen (nur Auth implementiert)
        async function handleLogin(formElement) { /* Implementierung wie zuvor */ }
        async function handleRegister(formElement) { /* Implementierung wie zuvor */ }
        async function handleForgotPassword(formElement) { /* Implementierung wie zuvor */ }
        async function handleUpdatePassword(formElement) { /* Implementierung wie zuvor */ }
        async function handleResendConfirmation() { /* Implementierung wie zuvor */ }
        async function handleLogout() { /* Implementierung wie zuvor */ }

        // Event Delegation Handler
        function handleAuthFormSubmit(event) { /* Wie zuvor */ }
        function handleAuthLinkClick(event) { /* Wie zuvor */ }

        // --- INITIALISIERUNG & AUTH STATE LISTENER ---
        function initializeApp() {
             console.log("initializeApp: Start");
             if (initError) { document.body.innerHTML = `<div style='color:red;padding:20px;'>FATAL: ${initError.message}</div>`; return; }
             if (!assignCoreDomElements()) { return; } // Stoppt, wenn Elemente fehlen

             // Event Delegation Listener
             if (loginBox) { loginBox.addEventListener('submit', handleAuthFormSubmit); loginBox.addEventListener('click', handleAuthLinkClick); }
             else { console.error("LoginBox fehlt!"); return; }

             // Statische Listener
             if (logoutButton) logoutButton.addEventListener('click', handleLogout);

             // Auth State Listener
             if (supabase) {
                 supabase.auth.onAuthStateChange((event, session) => {
                    console.log(`>>> onAuthStateChange: Event=${event}, Session=${session ? 'vorhanden' : 'null'}`);
                    if (!loginModal || !mainContent || !userProfileDiv || !logoutButton || !loginBox) { console.error("onAuthStateChange: Kern-UI fehlt!"); return; } // loginBox hinzugefügt

                    try {
                        // Standardmäßig alles verstecken, was nicht explizit gezeigt wird
                        hideUIElement(mainContent);
                        hideUIElement(loginModal); // Verstecke Modal, bevor wir entscheiden, was zu zeigen ist
                        hideUIElement(logoutButton);
                        hideUIElement(userProfileDiv);

                        if (event === 'PASSWORD_RECOVERY') {
                            console.log("STATE: PASSWORD_RECOVERY");
                            showUpdatePasswordForm(); // Diese Funktion zeigt das Modal
                        } else if (session?.user) {
                             const user = session.user;
                             console.log(`   User: ${user.id}, Bestätigt: ${user.email_confirmed_at}`);
                             if (user.email_confirmed_at || !user.email) {
                                 console.log("STATE: SIGNED_IN (bestätigt)");
                                 currentUser = user;
                                 if(usernameDisplay) usernameDisplay.textContent = currentUser.user_metadata?.display_name || 'User';
                                 // Zeige Hauptinhalt und Profil
                                 showUIElement(mainContent);
                                 showUIElement(userProfileDiv);
                                 showUIElement(logoutButton);
                             } else {
                                 console.log("STATE: SIGNED_IN (unbestätigt)");
                                 currentUser = null; // Behandle als nicht voll eingeloggt
                                 showConfirmationMessage(user.email); // Diese Funktion zeigt das Modal
                             }
                        } else { // Keine Session
                             console.log("STATE: Keine Session");
                             currentUser = null;
                             if(usernameDisplay) usernameDisplay.textContent = 'Spieler';
                             // Zeige Login Formular
                             showLoginForm(); // Diese Funktion zeigt das Modal
                        }
                    } catch (uiError) {
                         console.error("Fehler im onAuthStateChange UI Update:", uiError);
                         // Notfall: Versuche Login anzuzeigen
                          try { showLoginForm("UI Fehler aufgetreten."); } catch(e){}
                    }
                 });
                 console.log("initializeApp: Auth Listener gesetzt.");
             } else { console.error("initializeApp: Supabase nicht bereit!"); }

             console.log("initializeApp: Beendet.");
         }

        // --- START DER ANWENDUNG ---
        if (document.readyState === 'loading') {
             document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
             initializeApp();
        }
        console.log("SCRIPT END");
    </script>

</body>
</html>